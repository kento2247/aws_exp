<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>LIFF AUTH</title>
</head>
<body>
    <h1>Authenticating...</h1>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const service_id = urlParams.get('service_id');
            await liff.init({ liffId: "2001459172-KopGbo3y", withLoginOnExternalBrowser: true })
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile()
                const username = profile.displayName
                const userId = profile.userId
                const pictureUrl = profile.pictureUrl

                if (service_id) {
                    let url = 'https://sample-html-resource.s3.amazonaws.com/liff-login.html'
                    url += `?line_id=${userId}&username=${username}&profile_image_url=${pictureUrl}&service_id=${service_id}`
                    window.location.replace(url);
                }
                else {
                    const postData = {
                        "tablename": "lineId_to_serviceInfo",
                        "method": "query",
                        "query": [
                            {
                                "key": "line_id",
                                "value": userId
                            }
                        ]
                    }
                    // POST request
                    const result = await fetch('https://mqa60zu459.execute-api.us-east-1.amazonaws.com/sample', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        json: true,
                        body: JSON.stringify(postData),
                    });
                    const resultJson = await result.json();
                    const data = JSON.parse(resultJson.body)
                    if (data.length == 0) {
                        // console.log('no service_id found')
                        alert('no service_id found')
                        console.log('line_id: ', userId)
                        //resist new service_id
                    }
                    else {
                        console.log("data: ", data)
                        const service_id = data[0].service_id
                        let url = 'https://sample-html-resource.s3.amazonaws.com/liff-login.html'
                        url += `?line_id=${userId}&username=${username}&profile_image_url=${pictureUrl}&service_id=${service_id}`
                        window.location.replace(url);
                    }
                }
            } else {
                liff.login()
            }
        }
        main()
    </script>
</body>
</html>